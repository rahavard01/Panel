import{r as f,g as V,i as l,w as A,u as ve,f as ye,c as i,a,l as j,y as B,F as U,s as Y,n as x,b as _,t as o,d as q,o as u,q as he,p as Ne,B as xe}from"./app-B_MvGmoT.js";const Pe={class:"billing-root"},Se={class:"filters-row"},ke=["value"],Ce={class:"table-shell"},we={class:"table-scroll table-scroll-rtl"},Ie={class:"table table-bordered mt-4 text-center billing-table"},Ae={class:"billing-thead"},Le={class:"th-sort-inner"},Te={key:0},ze={key:1},Fe={key:0},Me={key:1},De={class:"cell-users"},Ee={key:0},$e={key:1},Re=["onClick"],Ve={class:"tx-type-cell"},je={class:"tx-type-label"},Be={class:"pagination-wrapper"},Ue={style:{display:"flex","align-items":"center",gap:"10px"}},Ye=["disabled"],qe=["disabled"],He={style:{opacity:".7"}},Ge=["disabled"],Je=["disabled"],Qe={__name:"Invoices",setup(Ke){const c=f([]),P=f([]),S=f("");async function H(){try{const{data:t}=await q.get("/admin/partners",{params:{per_page:1e3}}),e=Array.isArray(t?.data)?t.data:Array.isArray(t)?t:[];P.value=e.filter(n=>Number(n.role)!==1).map(n=>({code:n.panel_code||n.code||"-"})).sort((n,r)=>String(n.code||"").localeCompare(String(r.code||""),"fa"))}catch{P.value=[]}}function G(){s.currentPage=1,I()}const s=V({pageSize:20,currentPage:1}),k=l(()=>c.value.length),b=l(()=>Math.max(1,Math.ceil(k.value/s.pageSize)));A(()=>s.pageSize,()=>{s.currentPage=1}),A([()=>c.value.length,()=>s.pageSize],()=>{const t=b.value;s.currentPage>t&&(s.currentPage=t)});const v=l(()=>s.currentPage<=1),y=l(()=>s.currentPage>=b.value),d=f(!1);function J(){d.value=!d.value,s.currentPage=1}const{poll60:K}=ve();function L(t){if(t==null)return Number.NEGATIVE_INFINITY;const e=new Date(t);if(!Number.isNaN(e.getTime()))return e.getTime();const n=Number(t);return Number.isNaN(n)?Number.NEGATIVE_INFINITY:n}const T=l(()=>[...c.value].map((t,e)=>({...t,__i:e})).sort((t,e)=>{const n=L(t.created_at??t.date??t.datetime??t.id),r=L(e.created_at??e.date??e.datetime??e.id);return n===r?(Number(t.id)||0)-(Number(e.id)||0)||t.__i-e.__i:n-r}).map(({__i:t,...e})=>e)),O=l(()=>[...T.value].reverse()),Q=l(()=>d.value?T.value:O.value),z=l(()=>{const t=(s.currentPage-1)*s.pageSize;return Q.value.slice(t,t+s.pageSize)});function W(){v.value||(s.currentPage=1)}function X(){v.value||s.currentPage--}function Z(){y.value||s.currentPage++}function ee(){y.value||(s.currentPage=b.value)}const C=f(!1),F=f(""),h={"شارژ کیف پول":1,wallet_topup_card:1,topup:1,charge_wallet:1,panel_topup:1,اصلاحیه:-1,wallet_adjust:-1,"خرید اکانت":-1,buy_account:-1,"تمدید اکانت":-1,extend_account:-1,"ترافیک اضافه":-1,traffic_add:-1,"کمیسیون معرّف":1,referrer_commission:1},{formatPrettyUsername:te}=xe(),w=V({});function M(t){const e=(t||"").toString().trim().toLowerCase();return h[t]!==void 0?h[t]===1:e in h?h[e]===1:(Number(this?.amount)||0)>0}function ne(t){const e=(t||"").toString().trim().toLowerCase();return["wallet_topup_card","topup","charge_wallet","panel_topup","wallet_charge"].includes(e)?"شارژ کیف پول":["wallet_adjust","adjust","correction"].includes(e)?"اصلاحیه":["account_purchase","buy_account","purchase"].includes(e)?"خرید اکانت":["account_extend","extend_account","renew","renewal"].includes(e)?"تمدید اکانت":["traffic_purchase","add_traffic","extra_traffic"].includes(e)?"ترافیک اضافه":["referrer_commission","referral_commission","commission_referrer"].includes(e)?"کمیسیون معرّفی":/^[\u0600-\u06FF\s]+$/.test(t||"")?t:"—"}function ae(t){const e=Number(t);return Number.isNaN(e)?(t??"").toString():new Intl.NumberFormat("fa-IR",{useGrouping:!1}).format(e)}function se(t,e,n){const r=(t||"").toString().trim().toLowerCase(),$=["account_purchase","buy_account","purchase"],_e=["account_extend","extend_account","renew","renewal"],be=["traffic_purchase","traffic_add","add_traffic","extra_traffic"],N=(e||"").toString().replace(/^\s*اکانت\s+/,"").trim();let p=0;if(n!=null){if(typeof n=="string"){const R=n.match(/(\d+)/);p=Number(R?R[1]:n)}else p=Number(n);Number.isFinite(p)||(p=0)}return be.includes(r)?p>0?`${ae(p)}  گیگ ترافیک اضافه`:"ترافیک اضافه":N&&$.includes(r)?`خرید اکانت ${N}`:N&&_e.includes(r)?`تمدید اکانت ${N}`:ne(t)}function re(t){const e=(t??"").toString().trim().toLowerCase();return e==="1"||e==="admin"||e==="ادمین"?"ادمین":e==="2"||e==="user"||e==="کاربر"?"کاربر":e==="3"||e==="staff"||e==="کارمند"?"کارمند":e==="4"||e==="system"||e==="سیستم"?"سیستم":"نامشخص"}function g(t){return te(String(t||""))||"-"}function oe(t){return t?Array.isArray(t)?t.map(g).join("، "):g(t):"-"}function ie(t){const e=(t||"").toString().trim().toLowerCase();return["wallet_topup_card","wallet_topup","topup","charge_wallet","panel_topup","wallet_adjust"].includes(e)}function ue(t){const e=(t||"").toString().toLowerCase();return e==="success"?"موفق":e==="failed"?"ناموفق":e==="pending"?"در انتظار":t||"-"}function le(t){const e=(t||"").toString().toLowerCase();return{chip:!0,"chip--success":e==="success","chip--pending":e==="pending","chip--failed":e!=="success"&&e!=="pending"}}function ce(t){const e=Number(t)<0;return{amount:!0,"amount--neg":e,"amount--pos":!e}}function de(t){const e=M(t);return{"tx-arrow":!0,"tx-arrow--up":e,"tx-arrow--down":!e}}function pe(t){return M(t)?"▲":"▼"}function D(t){const e=Number(t);return Number.isNaN(e)?"-":e.toLocaleString("fa-IR")}function fe(t){const e=Number(t)||0;return`${e<0?"-":"+"} ${D(Math.abs(e))}`}function ge(t){if(!t)return"-";const e=new Date(t);return isNaN(e.getTime())?String(t):new Intl.DateTimeFormat("fa-IR",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(e)}async function I({silent:t=!1,keepPage:e=!0}={}){t||(C.value=!0),F.value="";const n=s.currentPage;try{const{data:r}=await q.get("/admin/transactions",{params:{panel_code:S.value||""}});c.value=Array.isArray(r)?r:[],e?s.currentPage=Math.min(n,Math.max(1,Math.ceil(c.value.length/s.pageSize))):s.currentPage=1}catch(r){console.error("fetchTransactions error",r),F.value="خطا در دریافت لیست تراکنش‌ها",c.value=[]}finally{t||(C.value=!1)}}ye(async()=>{await H(),await I({keepPage:!1})});function E(t){return!!w[t]}function me(t){w[t]=!w[t]}function m(t){if(ie(t.type)){const n=t.user_code??t.code??localStorage.getItem("code")??localStorage.getItem("me_code");return n?[g(n)]:[]}const e=t.affected_users??t.username??t.usernames??null;return e?Array.isArray(e)?e.map(g).filter(Boolean):[g(e)]:[]}return A(K,()=>{I({silent:!0,keepPage:!0})}),(t,e)=>(u(),i("div",Pe,[e[18]||(e[18]=a("h3",{class:"topup-title"},"صورتحساب همکاران",-1)),a("div",Se,[j(a("select",{"onUpdate:modelValue":e[0]||(e[0]=n=>S.value=n),class:"form-input",onChange:G,style:{"min-width":"160px"}},[e[2]||(e[2]=a("option",{value:""},"همه",-1)),(u(!0),i(U,null,Y(P.value,n=>(u(),i("option",{key:n.code,value:n.code},o(n.code),9,ke))),128))],544),[[B,S.value]])]),a("div",Ce,[a("div",we,[a("table",Ie,[a("thead",Ae,[a("tr",null,[e[4]||(e[4]=a("th",null,"تاریخ",-1)),e[5]||(e[5]=a("th",null,"اعتبار کیف پول پس از تراکنش",-1)),e[6]||(e[6]=a("th",null,"مبلغ تراکنش",-1)),e[7]||(e[7]=a("th",null,"وضعیت",-1)),e[8]||(e[8]=a("th",null,"نام کاربری/پنل",-1)),e[9]||(e[9]=a("th",null,"اپراتور",-1)),e[10]||(e[10]=a("th",null,"نوع تراکنش",-1)),a("th",{onClick:J,class:"th-sortable"},[a("span",Le,[e[3]||(e[3]=a("span",null,"ردیف",-1)),a("span",{class:x(["sort-caret",{up:d.value,down:!d.value}]),"aria-hidden":"true"},null,2)])])])]),a("tbody",null,[C.value?(u(),i("tr",Te,e[11]||(e[11]=[a("td",{colspan:8,class:"table-info-row"},[_("... در حال بارگذاری "),a("i",{class:"fas fa-spinner fa-spin"})],-1)]))):z.value.length===0?(u(),i("tr",ze,e[12]||(e[12]=[a("td",{colspan:8,class:"table-info-row"},[_("هیچ تراکنشی یافت نشد "),a("i",{class:"fas fa-exclamation-triangle",style:{"margin-left":"8px"}})],-1)]))):(u(!0),i(U,{key:2},Y(z.value,(n,r)=>(u(),i("tr",{key:n.id},[a("td",null,o(ge(n.created_at??n.date??n.datetime)),1),a("td",null,[(n.status||"").toLowerCase()==="pending"?(u(),i("span",Fe,"—")):(u(),i("span",Me,o(D(n.balance_after??n.wallet_after)),1))]),a("td",{class:x(ce(n.signed_amount))},o(fe(n.signed_amount)),3),a("td",null,[a("span",{class:x(le(n.status))},o(ue(n.status)),3)]),a("td",De,[m(n).length?(u(),i("span",Ee,o(oe(E(n.id)?m(n):m(n).slice(0,1))),1)):(u(),i("span",$e,"-")),m(n).length>1?(u(),i("button",{key:2,onClick:Ne($=>me(n.id),["stop"]),class:"more-less-btn",title:"نمایش/بستن بقیه"},o(E(n.id)?"کمتر":`+${m(n).length-1} بیشتر`),9,Re)):he("",!0)]),a("td",null,o(re(n.performed_by_role||n.operator)),1),a("td",Ve,[a("bdi",je,o(se(n.type,n.plan_label,n.traffic_gb)),1),a("span",{class:x(de(n.type))},o(pe(n.type)),3)]),a("td",null,o(d.value?(s.currentPage-1)*s.pageSize+r+1:k.value-((s.currentPage-1)*s.pageSize+r)),1)]))),128))])])])]),a("div",Be,[a("div",Ue,[a("button",{onClick:W,disabled:v.value,class:"btn-pager"},"⏮︎",8,Ye),a("button",{onClick:X,disabled:v.value,class:"btn-pager"},e[13]||(e[13]=[a("span",{class:"pagination-icon"},"◀",-1)]),8,qe),a("span",null,[_(" صفحه "+o(s.currentPage)+" از "+o(b.value)+" ",1),a("span",He,"( کل تراکنش ها : "+o(k.value)+" )",1)]),a("button",{onClick:Z,disabled:y.value,class:"btn-pager"},e[14]||(e[14]=[a("span",{class:"pagination-icon"},"▶",-1)]),8,Ge),a("button",{onClick:ee,disabled:y.value,class:"btn-pager"},"⏭︎",8,Je)]),a("div",null,[e[16]||(e[16]=_(" نمایش ",-1)),j(a("select",{"onUpdate:modelValue":e[1]||(e[1]=n=>s.pageSize=n),style:{background:"#2a2a2a",color:"#fff",border:"1px solid #444","border-radius":"6px",padding:"4px 8px",margin:"0 6px"}},e[15]||(e[15]=[a("option",{value:20},"20",-1),a("option",{value:50},"50",-1),a("option",{value:100},"100",-1),a("option",{value:500},"500",-1)]),512),[[B,s.pageSize,void 0,{number:!0}]]),e[17]||(e[17]=_(" ردیف در هر صفحه ",-1))])])]))}};export{Qe as default};
